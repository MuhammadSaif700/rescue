<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RescueEye Global - AI-Powered Disaster Detection</title>
    <!-- <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script> -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #0f0f23, #1a1a3e, #2d1b69);
        color: white;
        overflow-x: hidden;
      }

      .navbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(15, 15, 35, 0.95);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.5rem;
        font-weight: 700;
        color: #ff6b6b;
      }

      .logo i {
        font-size: 2rem;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      /* Navigation links */
      .nav-links {
        display: flex;
        gap: 1rem;
      }

      .nav-link {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .nav-link:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      .nav-link.active {
        background: rgba(78, 205, 196, 0.4);
        border-color: #4ecdc4;
        color: white;
        box-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
      }

      .main-container {
        margin-top: 80px;
        height: calc(100vh - 80px);
        width: 100%;
        display: block; /* Change from grid to block */
      }

      .sidebar {
        background: rgba(15, 15, 35, 0.9);
        backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        padding: 2rem;
        overflow-y: auto;
      }

      .map-container {
        position: relative;
        background: #1a1a3e;
        height: calc(100vh - 160px);
        border-radius: 12px;
        overflow: hidden;
        margin-right: 10px !important;
      }

      #map {
        width: 100%;
        height: 100%;
        filter: brightness(0.8) contrast(1.2) hue-rotate(210deg);
      }

      .hero-section {
        margin-bottom: 2rem;
        text-align: center;
      }

      .hero-title {
        font-size: 1.8rem;
        font-weight: 800;
        background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
      }

      .hero-subtitle {
        color: #a0a0a0;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .input-section {
        margin-bottom: 2rem;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #4ecdc4;
      }

      .input-container {
        margin-bottom: 1rem;
        padding-left: 10px !important;
        padding-right: 10px !important;
      }

      .disaster-input {
        width: 100%;
        padding: 1rem 1.2rem;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: white;
        font-size: 1rem;
        transition: all 0.3s ease;
        outline: none;
        min-height: 100px;
        resize: vertical;
      }

      .disaster-input:focus {
        border-color: #4ecdc4;
        box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
        transform: translateY(-2px);
      }

      .submit-btn {
        width: calc(100% - 20px) !important;
        padding: 1rem;
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        margin-left: 10px !important;
        margin-right: 10px !important;
      }

      .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
      }

      .submit-btn:active {
        transform: translateY(0);
      }

      .submit-btn.processing {
        background: linear-gradient(135deg, #ffa726, #ff9800);
        animation: processing 1.5s infinite;
      }

      @keyframes processing {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .quick-examples {
        margin-bottom: 2rem;
        padding-left: 10px !important;
      }

      .example-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-left: 5px !important;
      }

      .example-chip {
        padding: 0.5rem 1rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .example-chip:hover {
        background: rgba(78, 205, 196, 0.2);
        border-color: #4ecdc4;
        transform: translateY(-1px);
      }

      .alerts-section {
        margin-bottom: 2rem;
      }

      .alerts-list {
        max-height: 300px;
        overflow-y: auto;
      }

      .alert-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
        animation: slideIn 0.5s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .alert-item:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
      }

      .alert-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .alert-icon.fire {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
      }

      .alert-icon.flood {
        background: linear-gradient(135deg, #45b7d1, #2980b9);
        color: white;
      }

      .alert-icon.earthquake {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
      }

      .alert-icon.landslide {
        background: linear-gradient(135deg, #8b4513, #a0522d);
        color: white;
      }

      .alert-info {
        flex: 1;
      }

      .alert-type {
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: capitalize;
      }

      .alert-location {
        color: #a0a0a0;
        font-size: 0.8rem;
        margin-top: 0.2rem;
      }

      .alert-time {
        color: #4ecdc4;
        font-size: 0.7rem;
        margin-top: 0.2rem;
      }

      .filters-section {
        margin-bottom: 2rem;
      }

      .filter-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .filter-btn {
        padding: 0.7rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: white;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
      }

      .filter-btn:hover,
      .filter-btn.active {
        background: rgba(78, 205, 196, 0.2);
        border-color: #4ecdc4;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-left: 4px solid #4ecdc4;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .status-indicator {
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 0.5rem 1rem;
        background: rgba(76, 175, 80, 0.9);
        color: white;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        z-index: 1000;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .custom-marker {
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
        border: 3px solid white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        animation: markerPulse 2s infinite;
      }

      @keyframes markerPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .status-badge {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 700;
        margin-top: 6px;
        margin-right: 8px;
      }
      .status-pending {
        background: #ffa726;
        color: #fff;
      }
      .status-verified {
        background: #4caf50;
        color: #fff;
      }
      .status-resolved {
        background: #607d8b;
        color: #fff;
      }
      .status-btn {
        margin-left: 0.5rem;
        padding: 2px 8px;
        font-size: 0.7rem;
        border: none;
        border-radius: 8px;
        background: #4ecdc4;
        color: #fff;
        cursor: pointer;
        transition: background 0.2s;
      }
      .status-btn:hover {
        background: #45b7d1;
      }

      /* Add this to your <style> section */
      select option {
        background-color: #1a1a3e;
        color: white;
      }

      select {
        appearance: auto;
      }

      /* For Firefox */
      @-moz-document url-prefix() {
        select {
          background-color: #1a1a3e;
          color: white;
        }
      }

      /* Emergency type button styles */
      .emergency-type-btn {
        padding: 0.5rem;
        border-radius: 8px;
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid rgba(255, 107, 107, 0.3);
        color: #ccc;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .emergency-type-btn:hover {
        background: rgba(255, 107, 107, 0.2);
        border-color: rgba(255, 107, 107, 0.5);
        color: white;
      }

      /* Much more prominent active state */
      .emergency-type-btn.active {
        background: rgba(255, 107, 107, 0.8); /* Much stronger background */
        border: 2px solid #ff6b6b; /* Thicker border */
        color: white;
        font-weight: bold;
        transform: translateY(-3px); /* Slightly raised button */
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.7); /* Stronger glow */
      }

      /* Add this to your <style> section */

      /* Section layouts */
      .app-section {
        display: none !important;
        width: 100%;
        opacity: 0;
        transition: opacity 0.3s ease;
        height: calc(100vh - 80px);
        overflow-y: auto;
      }

      .active-section {
        display: block !important;
        opacity: 1 !important;
      }

      .section-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        height: calc(100vh - 160px);
        max-width: 100%;
      }

      .section-content {
        overflow-y: auto;
        padding-right: 1rem;
      }

      .section-content.full-width {
        max-width: 800px;
        margin: 0 auto;
      }

      #location-section .section-content,
      #ai-section .section-content {
        max-width: 800px;
        margin: 0 auto;
        background: rgba(26, 26, 62, 0.5);
        padding: 2rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      #location-section .input-container,
      #ai-section .input-container {
        margin-bottom: 1.5rem;
      }

      #locationStatus,
      #aiReply {
        margin-top: 2rem;
        background: rgba(15, 15, 35, 0.7);
        border-radius: 12px;
        padding: 1.5rem;
        min-height: 200px;
      }

      @media (max-width: 768px) {
        .main-container {
          grid-template-columns: 1fr;
          grid-template-rows: 400px 1fr;
        }

        .navbar {
          padding: 1rem;
        }

        .nav-stats {
          display: none;
        }

        .sidebar {
          padding: 1rem;
        }

        .section-layout {
          grid-template-columns: 1fr;
          grid-template-rows: 1fr 400px;
        }

        .nav-links {
          display: flex;
          overflow-x: auto;
          white-space: nowrap;
          padding-bottom: 0.5rem;
          gap: 0.5rem;
        }

        .nav-link {
          padding: 0.5rem;
          font-size: 0.8rem;
        }
      }

      /* Ensure these CSS rules are applied */
      .app-section {
        display: none;
        width: 100%;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .active-section {
        display: block !important;
        opacity: 1 !important;
      }

      /* Add these styles to your <style> section */
      .rec-btn {
        padding: 0.7rem 1rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
        justify-content: center;
      }

      .rec-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      .rec-btn.active {
        background: rgba(255, 107, 107, 0.3);
        border-color: #ff6b6b;
        color: white;
      }

      .rec-btn.active:nth-of-type(1) {
        background: rgba(255, 107, 107, 0.3);
        border-color: #ff6b6b;
      }

      .rec-btn.active:nth-of-type(2) {
        background: rgba(255, 167, 38, 0.3);
        border-color: #ffa726;
      }

      .rec-btn.active:nth-of-type(3) {
        background: rgba(78, 205, 196, 0.3);
        border-color: #4ecdc4;
      }

      input[type="checkbox"] {
        margin-right: 0.5rem;
      }

      /* Add this to your <style> section */
      .emergency-type-selection {
        padding-left: 10px !important;
      }

      .quick-examples {
        padding-left: 10px !important;
      }

      .example-chips {
        padding-left: 5px !important;
      }

      /* Make the Report Emergency heading match other elements' alignment */
      .section-title {
        padding-left: 10px !important;
      }

      /* Fix the input fields to match alignment */
      .input-container {
        padding-left: 10px !important;
        padding-right: 10px !important;
      }

      /* Fix for Report Emergency buttons and other submit buttons */
      .submit-btn {
        width: calc(100% - 20px) !important;
        margin-left: 10px !important;
        margin-right: 10px !important;
      }

      /* Fix for Location Status button */
      button#locationBtn.submit-btn {
        width: calc(100% - 20px) !important;
        margin-left: 10px !important;
        margin-right: 10px !important;
        display: block !important;
      }

      /* Also ensure the parent container has proper padding */
      #location-section .input-section button#locationBtn {
        margin-left: 10px !important;
        margin-right: 10px !important;
      }

      /* Apply the same style to all buttons in the location section */
      #location-section .submit-btn {
        width: calc(100% - 20px) !important;
        margin-left: 10px !important;
        margin-right: 10px !important;
      }
      /* Add these CSS rules to fix the button alignment */

      /* Target the Report Emergency button at the bottom specifically */

      /* Fix severity dropdown */

      /* Super specific rule to target ALL input fields including the Location field */
      input[type="text"],
      input[id="emergencyLocation"],
      input[id="locationInput"],
      input[id="emergencySeverity"],
      textarea,
      .disaster-input {
        width: calc(100% - 20px) !important;
        margin-left: 10px !important;
        margin-right: 10px !important;
        box-sizing: border-box !important;
        display: block !important;
      }

      /* Also fix any parent containers that might be overriding the margin */
      .input-container {
        padding-left: 0 !important;
        padding-right: 0 !important;
        width: 100% !important;
      }

      /* Extra specific rule for Location input in report section */
      #report-section input[id="emergencyLocation"] {
        margin-left: 0px !important;
        margin-right: 10px !important;
        width: calc(100% - 20px) !important;
      }
      #emergencySeverity-container[id="emergencySeverity"] {
        margin-left: 10px !important;
        margin-right: 10px !important;
        width: calc(100% - 20px) !important;
      }
      input[type="text"],
      input[id="emergencySeverity"],
      input[id="locationInput"],
      input[id="emergencySeverity"],
      textarea,
      .disaster-input {
        width: calc(100% - 20px) !important;
        margin-left: 10px !important;
        margin-right: 10px !important;
        box-sizing: border-box !important;
        display: block !important;
      }
      /* Fix for severity dropdown specifically */
      select#emergencySeverity {
        width: calc(100% - 20px) !important;
        margin-left: 10px !important;
        margin-right: 10px !important;
        box-sizing: border-box !important;
        display: block !important;
      }

      /* Target the container div that holds the select */
      div[style*="display: flex; gap: 0.5rem"] {
        margin-left: 10px !important;
        margin-right: 10px !important;
        width: calc(100% - 20px) !important;
      }

      /* Super specific selector to ensure it works */
      #report-section
        div[style*="display: flex; gap: 0.5rem"]
        > select#emergencySeverity {
        width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
      }

      /* Adjust inline style of select */
      #emergencySeverity {
        margin-left: 10px !important;
        width: calc(100% - 20px) !important;
      }

      /* Make all form elements in the emergency section consistent */
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="logo">
        <i class="fas fa-eye"></i>
        RescueEye Global
      </div>
      <div class="nav-links">
        <button class="nav-link active" data-section="report">
          <i class="fas fa-exclamation-circle"></i> Report Emergency
        </button>
        <button class="nav-link" data-section="location">
          <i class="fas fa-search-location"></i> Location Status
        </button>
        <button class="nav-link" data-section="ai">
          <i class="fas fa-robot"></i> AI Assistance
        </button>
      </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
      <!-- Section: Report Emergency -->
      <div class="app-section active-section" id="report-section">
        <div class="section-layout">
          <div class="section-content">
            <!-- Hero Section -->
            <div class="hero-section">
              <h1 class="hero-title">AI Disaster Detection</h1>
              <p class="hero-subtitle">
                Report disasters through natural language and see real-time
                alerts on the map
              </p>
            </div>

            <!-- Input Section -->
            <div class="input-section">
              <h2 class="section-title">
                <i class="fas fa-exclamation-circle"></i>
                Report Emergency
              </h2>
              <div
                class="emergency-type-selection"
                style="
                  margin-bottom: 1rem;
                  display: flex;
                  flex-wrap: wrap;
                  gap: 0.5rem;
                "
              >
                <!-- Emergency type buttons remain the same -->
                <button class="emergency-type-btn" data-type="accident">
                  <i class="fas fa-car-crash"></i> Accident
                </button>
                <button class="emergency-type-btn" data-type="fire">
                  <i class="fas fa-fire"></i> Fire
                </button>
                <!-- 
                <button class="emergency-type-btn" data-type="flood">
                  <i class="fas fa-water"></i> Flood
                </button>
                -->
                <button class="emergency-type-btn" data-type="medical">
                  <i class="fas fa-ambulance"></i> Medical
                </button>
                <button class="emergency-type-btn" data-type="other">
                  <i class="fas fa-exclamation-triangle"></i> Other
                </button>
              </div>
              <div class="input-container">
                <textarea
                  id="disasterInput"
                  class="disaster-input"
                  placeholder="Describe Emergency"
                ></textarea>
              </div>
              <div style="margin-bottom: 1rem">
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem">
                  <input
                    id="emergencyLocation"
                    class="disaster-input"
                    style="min-height: unset; flex: 1"
                    placeholder="Location"
                  />
                  <button
                    id="useMyLocation"
                    style="
                      padding: 0 1rem;
                      background: rgba(78, 205, 196, 0.2);
                      border: 1px solid #4ecdc4;
                      color: white;
                      border-radius: 8px;
                      cursor: pointer;
                    "
                  >
                    <i class="fas fa-map-marker-alt"></i>
                  </button>
                </div>
                <div style="display: flex; gap: 0.5rem">
                  <select
                    id="emergencySeverity"
                    style="
                      width: calc(100% - 20px) !important;
                      padding: 0.5rem;
                      width: 100% !important;
                      background: rgba(255, 255, 255, 0.05);
                      border: 1px solid rgba(255, 255, 255, 0.1);
                      border-radius: 8px;
                      color: white;
                      appearance: auto;
                    "
                  >
                    <option
                      value="low"
                      style="background: #1a1a3e; color: white"
                    >
                      Low Severity
                    </option>
                    <option
                      value="medium"
                      style="background: #1a1a3e; color: white"
                      selected
                    >
                      Medium Severity
                    </option>
                    <option
                      value="high"
                      style="background: #1a1a3e; color: white"
                    >
                      High Severity - Urgent
                    </option>
                    <option
                      value="critical"
                      style="background: #1a1a3e; color: white"
                    >
                      Critical - Life Threatening
                    </option>
                  </select>
                </div>
              </div>
              <button id="submitBtn" class="submit-btn">
                <i class="fas fa-exclamation-circle"></i>
                Report Emergency
              </button>
            </div>

            <!-- Quick Examples -->
            <div class="quick-examples">
              <h3 class="section-title">
                <i class="fas fa-lightbulb"></i>
                Quick Emergency Reports
              </h3>
              <div class="example-chips">
                <div
                  class="example-chip"
                  data-text="Car accident on Mall Road with 2 injured people"
                >
                  üöó Car Accident
                </div>
                <div
                  class="example-chip"
                  data-text="House fire in F-7 Islamabad, family trapped inside"
                >
                  üî• House Fire
                </div>
                <div
                  class="example-chip"
                  data-text="Medical emergency - heart attack at Centaurus Mall"
                >
                  üöë Medical Emergency
                </div>
                <div
                  class="example-chip"
                  data-text="Flooding on I-8 roads, cars stuck"
                >
                  üåä Road Flooding
                </div>
                <div
                  class="example-chip"
                  data-text="Gas leak in G-9 residential area"
                >
                  ‚ö†Ô∏è Gas Leak
                </div>
                <div
                  class="example-chip"
                  data-text="Building collapse in old city area"
                >
                  üè¢ Building Collapse
                </div>
              </div>
            </div>
          </div>

          <!-- Map Container - Only in Report section -->
          <div class="map-container">
            <div id="map"></div>
            <div class="loading-overlay" id="loadingOverlay">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Location Status -->
      <div class="app-section" id="location-section">
        <div class="section-content full-width">
          <div class="hero-section">
            <h1 class="hero-title">Location Status Check</h1>
            <p class="hero-subtitle">
              Check the current conditions and disaster status of any location
              worldwide
            </p>
          </div>

          <!-- Location Status Section -->
          <div class="input-section">
            <h2 class="section-title">
              <i class="fas fa-search-location"></i>
              Check Location Status
            </h2>
            <div class="input-container">
              <input
                id="locationInput"
                class="disaster-input"
                style="min-height: unset"
                placeholder="Enter city or location (e.g. London, Lahore, Tokyo)"
              />
            </div>
            <button id="locationBtn" class="submit-btn">
              <i class="fas fa-search"></i>
              Check Status
            </button>
            <div id="locationStatus" style="margin-top: 1rem"></div>
          </div>
        </div>
      </div>

      <!-- Section: AI Assistance -->
      <div class="app-section" id="ai-section">
        <div class="section-content full-width">
          <!-- Update the header section -->
          <div class="hero-section">
            <h1 class="hero-title">AI Assistance</h1>
            <p class="hero-subtitle">
              Get real-time AI help with weather conditions and emergency
              situations
            </p>
          </div>

          <!-- AI Assistant section - keeping only this part -->
          <div class="input-section" style="margin-top: 2rem">
            <h2 class="section-title">
              <i class="fas fa-robot"></i>
              Ask AI Assistant
            </h2>
            <div class="input-container">
              <input
                id="aiInput"
                type="text"
                class="disaster-input"
                style="min-height: unset"
                placeholder="Ask about weather or disasters (e.g., 'Is there flooding in London?' or 'Weather in Tokyo')"
              />
            </div>
            <button id="aiSubmit" class="submit-btn">
              <i class="fas fa-paper-plane"></i>
              Ask AI
            </button>
            <div
              id="aiReply"
              style="
                margin-top: 1rem;
                color: #e0e0e0;
                max-height: 300px;
                overflow-y: auto;
                padding-right: 10px;
              "
            >
              <div style="text-align: center; padding: 20px">
                <i
                  style="font-size: 24px; color: #4ecdc4; margin-bottom: 10px"
                ></i>
                <p>Welcome to RescueEye AI Assistant!</p>
                <p style="font-size: 0.9rem; color: #a0a0a0"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      const API_BASE = "https://rescue-production.up.railway.app";
      class RescueEyeApp {
        constructor() {
          this.map = null;
          this.alerts = [];
          this.markers = [];
          this.activeFilter = "all";
          this.activeStatusFilter = "all";
          this.chart = null;
          this.init();
        }

        init() {
          this.initMap();
          this.bindEvents();
          // this.loadAlertsFromBackend(); // Comment out this line
          // setInterval(() => this.loadAlertsFromBackend(), 10000); // Comment out this line to stop polling
          this.updateStats();
        }

        initMap() {
          // Initialize map centered on Pakistan
          this.map = L.map("map").setView([30.3753, 69.3451], 6);

          // Use Google Maps-like style
          L.tileLayer(
            "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
            {
              attribution: "¬© OpenStreetMap contributors, ¬© CartoDB",
              subdomains: "abcd",
              maxZoom: 19,
            }
          ).addTo(this.map);
        }

        bindEvents() {
          // Submit button
          document.getElementById("submitBtn").addEventListener("click", () => {
            this.processDisasterReport();
          });

          // Enter key in textarea
          document
            .getElementById("disasterInput")
            .addEventListener("keypress", (e) => {
              if (e.key === "Enter" && e.ctrlKey) {
                this.processDisasterReport();
              }
            });

          // Example chips
          document.querySelectorAll(".example-chip").forEach((chip) => {
            chip.addEventListener("click", () => {
              document.getElementById("disasterInput").value =
                chip.dataset.text;
              // Set a timeout to process after text is set
              setTimeout(() => this.processDisasterReport(), 100);
            });
          });

          // Location status button
          document
            .getElementById("locationBtn")
            .addEventListener("click", async () => {
              const location = document
                .getElementById("locationInput")
                .value.trim();
              if (!location) return;
              const statusDiv = document.getElementById("locationStatus");
              statusDiv.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Loading...';

              try {
                // --- Weather API (OpenWeatherMap) ---
                const weatherRes = await fetch(
                  `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(
                    location
                  )}&appid=21af7453a5b5eea1f18565bb32fb31af&units=metric`
                );
                const weatherData = await weatherRes.json();

                // --- Disaster API (your backend) ---
                const disasterRes = await fetch(
                  `${API_BASE}/disaster?location=${encodeURIComponent(
                    location
                  )}`
                );
                const disasterData = await disasterRes.json();

                // --- Show Results ---
                let html = `<strong>Weather:</strong> ${
                  weatherData.weather
                    ? weatherData.weather[0].description
                    : "Not found"
                }<br>
              <strong>Temperature:</strong> ${
                weatherData.main ? weatherData.main.temp + "¬∞C" : "N/A"
              }<br>
              <strong>Disaster Status:</strong> ${
                disasterData.status
                  ? disasterData.status
                  : "No disaster reported. Area is normal."
              }`;

                statusDiv.innerHTML = html;
              } catch (e) {
                statusDiv.innerHTML =
                  '<span style="color:red;">Failed to fetch data.</span>';
              }
            });

          // Emergency type selection
          document.querySelectorAll(".emergency-type-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              document
                .querySelectorAll(".emergency-type-btn")
                .forEach((b) => b.classList.remove("active"));
              btn.classList.add("active");
            });
          });

          // Use my location button
          document
            .getElementById("useMyLocation")
            .addEventListener("click", () => {
              document.getElementById("useMyLocation").innerHTML =
                '<i class="fas fa-spinner fa-spin"></i>';
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                  (position) => {
                    const { latitude, longitude } = position.coords;

                    // Reverse geocode to get address
                    fetch(
                      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`
                    )
                      .then((res) => res.json())
                      .then((data) => {
                        document.getElementById("emergencyLocation").value =
                          data.display_name || `${latitude}, ${longitude}`;
                        document.getElementById("useMyLocation").innerHTML =
                          '<i class="fas fa-map-marker-alt"></i>';
                      })
                      .catch(() => {
                        document.getElementById(
                          "emergencyLocation"
                        ).value = `${latitude}, ${longitude}`;
                        document.getElementById("useMyLocation").innerHTML =
                          '<i class="fas fa-map-marker-alt"></i>';
                      });
                  },
                  (error) => {
                    alert(
                      "Unable to get your location. Please enter it manually."
                    );
                    document.getElementById("useMyLocation").innerHTML =
                      '<i class="fas fa-map-marker-alt"></i>';
                  }
                );
              } else {
                alert("Geolocation is not supported by your browser");
                document.getElementById("useMyLocation").innerHTML =
                  '<i class="fas fa-map-marker-alt"></i>';
              }
            });

          // AI Submit button - Replace your existing AI submit handler
          document
            .getElementById("aiSubmit")
            .addEventListener("click", async () => {
              const userInput = document.getElementById("aiInput").value.trim();
              if (!userInput) return;

              const aiReplyDiv = document.getElementById("aiReply");

              // Show user's question and loading state
              aiReplyDiv.innerHTML = `
    <div style="margin-bottom: 10px;">
      <span style="font-weight: bold; color: #4ecdc4;">You asked:</span>
      <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 4px;">
        ${userInput}
      </div>
    </div>
    <div style="margin-top: 10px;">
      <span style="font-weight: bold; color: #4ecdc4;">AI Response:</span>
      <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 4px; white-space: pre-line;">
        <i class="fas fa-spinner fa-spin"></i> Analyzing weather and disaster data...
      </div>
    </div>
  `;

              document.getElementById("aiInput").value = "";

              try {
                // Extract location from user input using a more robust approach
                const location = extractLocationFromQuery(userInput);

                if (!location) {
                  // No location found in query
                  displayGeneralResponse(aiReplyDiv, userInput);
                  return;
                }

                // Get both weather and disaster data in parallel
                const [weatherData, disasterData] = await Promise.all([
                  fetchWeatherData(location),
                  fetchDisasterData(location),
                ]);

                // Generate comprehensive response
                const response = generateAIResponse(
                  userInput,
                  location,
                  weatherData,
                  disasterData
                );

                // Update the display with the formatted response
                aiReplyDiv.innerHTML = `
      <div style="margin-bottom: 10px;">
        <span style="font-weight: bold; color: #4ecdc4;">You asked:</span>
        <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 4px;">
          ${userInput}
        </div>
      </div>
      <div style="margin-top: 10px;">
        <span style="font-weight: bold; color: #4ecdc4;">AI Response:</span>
        <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 4px; white-space: pre-line;">
          ${response.replace(
            /\*\*(.*?)\*\*/g,
            '<strong style="color: #4ecdc4;">$1</strong>'
          )}
        </div>
      </div>
    `;
              } catch (e) {
                console.error("Error processing AI query:", e);
                aiReplyDiv.innerHTML = `
      <div style="margin-bottom: 10px;">
        <span style="font-weight: bold; color: #4ecdc4;">You asked:</span>
        <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 4px;">
          ${userInput}
        </div>
      </div>
      <div style="margin-top: 10px;">
        <span style="font-weight: bold; color: #4ecdc4;">AI Response:</span>
        <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 4px; color: #ff6b6b;">
          <i class="fas fa-exclamation-triangle"></i> I encountered an error while processing your weather request. Please try again or ask about a different location.
        </div>
      </div>
    `;
              }
            });

          // IMPORTANT: Fix navigation links
          document.querySelectorAll(".nav-link").forEach((link) => {
            link.addEventListener("click", () => {
              console.log("Navigation link clicked:", link.dataset.section);

              // Update active nav link
              document
                .querySelectorAll(".nav-link")
                .forEach((l) => l.classList.remove("active"));
              link.classList.add("active");

              // Show corresponding section
              const targetSection = link.dataset.section;
              document.querySelectorAll(".app-section").forEach((section) => {
                section.classList.remove("active-section");
              });

              const sectionToActivate = document.getElementById(
                `${targetSection}-section`
              );
              if (sectionToActivate) {
                sectionToActivate.classList.add("active-section");
              } else {
                console.error(
                  `Section with ID "${targetSection}-section" not found`
                );
              }
            });
          });
        }

        async processDisasterReport() {
          const input = document.getElementById("disasterInput").value.trim();
          const location = document
            .getElementById("emergencyLocation")
            .value.trim();

          // Check if emergency type is selected
          const selectedEmergencyType = document.querySelector(
            ".emergency-type-btn.active"
          );
          if (!selectedEmergencyType) {
            alert(
              "Please select an emergency type (Accident, Fire, Flood, etc.)"
            );
            return;
          }

          if (!input || !location) {
            alert(
              "Please provide both a description and location for the emergency."
            );
            return;
          }

          const submitBtn = document.getElementById("submitBtn");
          const loadingOverlay = document.getElementById("loadingOverlay");

          // Show loading state
          submitBtn.classList.add("processing");
          submitBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Submitting Report...';
          loadingOverlay.style.display = "flex";

          try {
            // Get selected emergency type
            const emergencyType = document.querySelector(
              ".emergency-type-btn.active"
            ).dataset.type;
            const severity = document.getElementById("emergencySeverity").value;
            const username = "anonymous"; // Replace localStorage.getItem("username") || "anonymous";

            // Get coordinates for the location
            const coordinates = await this.geocodeLocation(location);

            const res = await fetch(`${API_BASE}/analyze`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                text: input,
                location: location,
                type: emergencyType,
                severity: severity,
                username,
                coordinates: coordinates, // Add coordinates to the request
              }),
              credentials: "include",
            });

            const alert = await res.json();
            alert.timestamp = new Date(alert.timestamp);

            // Ensure we use our geocoded coordinates if the server didn't provide any
            if (
              !alert.coordinates ||
              !Array.isArray(alert.coordinates) ||
              alert.coordinates.length !== 2
            ) {
              alert.coordinates = coordinates;
            }

            // Add emergency icon based on type
            if (!alert.icon) {
              const icons = {
                accident: "üöó",
                fire: "üî•",
                flood: "üåä",
                medical: "üöë",
                other: "‚ö†Ô∏è",
              };
              alert.icon = icons[emergencyType] || "‚ö†Ô∏è";
            }

            this.alerts.unshift(alert);
            this.updateAlertsDisplay();
            this.addMapMarker(alert);
            this.updateStats();

            // Clear form
            document.getElementById("disasterInput").value = "";
            document.getElementById("emergencyLocation").value = "";

            this.showSuccessMessage("Emergency reported successfully!");

            // Show browser notification
            if (window.Notification && Notification.permission === "granted") {
              new Notification("Emergency Report Submitted", {
                body: `${emergencyType.toUpperCase()} report at ${location} has been submitted`,
                icon: "your-logo.png",
              });
            }
          } catch (e) {
            alert("Failed to submit emergency report. Please try again.");
            console.error(e);
          }

          // Reset button state
          submitBtn.classList.remove("processing");
          submitBtn.innerHTML =
            '<i class="fas fa-exclamation-circle"></i> Report Emergency';
          loadingOverlay.style.display = "none";
        }

        // Add this new geocoding function to replace the current one
        async geocodeLocation(locationString) {
          try {
            console.log("Attempting to geocode:", locationString);

            // First attempt - using OpenStreetMap Nominatim
            try {
              const response = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                  locationString
                )}&limit=1`,
                {
                  headers: {
                    "User-Agent":
                      "RescueEye Emergency App (emergency-response-app)",
                  },
                }
              );

              if (response.ok) {
                const data = await response.json();
                if (data && data.length > 0) {
                  const lat = parseFloat(data[0].lat);
                  const lon = parseFloat(data[0].lon);
                  console.log(
                    `‚úì OSM Geocoding successful: ${locationString} ‚Üí [${lat}, ${lon}]`
                  );
                  return [lat, lon];
                }
              }
              console.log("‚úó OSM Geocoding failed, trying alternative method");
            } catch (e) {
              console.log("‚úó OSM Geocoding error:", e.message);
            }

            // Second attempt - using MapBox API (doesn't require API key for geocoding)
            try {
              const response = await fetch(
                `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(
                  locationString
                )}.json?access_token=pk.eyJ1IjoicmVzY3VlZXllIiwiYSI6ImNsa3N1czdzazAzdm0zZnA3NG01dnJoOHUifQ.jheGl7gfwAtt-MNj8mj0Qg`
              );

              if (response.ok) {
                const data = await response.json();
                if (data && data.features && data.features.length > 0) {
                  const coords = data.features[0].geometry.coordinates;
                  // MapBox returns [lon, lat] but we need [lat, lon]
                  console.log(
                    `‚úì MapBox Geocoding successful: ${locationString} ‚Üí [${coords[1]}, ${coords[0]}]`
                  );
                  return [coords[1], coords[0]];
                }
              }
              console.log("‚úó MapBox Geocoding failed, using hardcoded lookup");
            } catch (e) {
              console.log("‚úó MapBox Geocoding error:", e.message);
            }

            // Third attempt - simple lookup table for common cities
            const cityCoords = {
              lahore: [31.5204, 74.3587],
              karachi: [24.8607, 67.0011],
              islamabad: [33.6844, 73.0479],
              peshawar: [34.0151, 71.5249],
              quetta: [30.1798, 67.0015],
              multan: [30.1575, 71.5249],
              faisalabad: [31.4504, 73.135],
              rawalpindi: [33.5651, 73.0169],
              gujranwala: [32.1877, 74.1945],
              sialkot: [32.4945, 74.5229],
              "new york": [40.7128, -74.006],
              london: [51.5074, -0.1278],
              tokyo: [35.6762, 139.6503],
              paris: [48.8566, 2.3522],
            };

            // Try to find city in lookup table (case insensitive)
            const normalizedLocation = locationString.toLowerCase();
            for (const [city, coords] of Object.entries(cityCoords)) {
              if (normalizedLocation.includes(city)) {
                console.log(
                  `‚úì Found city in lookup table: ${city} ‚Üí [${coords[0]}, ${coords[1]}]`
                );
                return coords;
              }
            }

            console.warn(
              `‚ö† All geocoding methods failed for: ${locationString}`
            );
            // Default to center of Pakistan if all else fails
            return [30.3753, 69.3451];
          } catch (error) {
            console.error(`‚ùå Critical geocoding error: ${error.message}`);
            return [30.3753, 69.3451]; // Default to Pakistan coordinates
          }
        }

        addMapMarker(alert) {
          // Log what we're trying to do
          console.log(
            "%cADDING MARKER",
            "background: green; color: white; padding: 3px;"
          );
          console.log("Location:", alert.location);
          console.log("Coordinates:", alert.coordinates);

          if (
            !Array.isArray(alert.coordinates) ||
            alert.coordinates.length !== 2
          ) {
            console.error("Invalid coordinates format:", alert.coordinates);
            return;
          }

          // Force the coordinates to be numbers (important for Leaflet)
          const lat = parseFloat(alert.coordinates[0]);
          const lng = parseFloat(alert.coordinates[1]);

          if (isNaN(lat) || isNaN(lng)) {
            console.error(
              "Coordinates are not valid numbers:",
              alert.coordinates
            );
            return;
          }

          const validCoordinates = [lat, lng];
          console.log("Parsed coordinates:", validCoordinates);

          const color = this.getAlertColor(alert.type);

          // Create custom marker
          const markerHtml = `
            <div class="custom-marker" style="background: ${color};">
                ${alert.icon}
            </div>
          `;

          try {
            // Add marker to map with validated coordinates
            const marker = L.marker(validCoordinates, {
              icon: L.divIcon({
                html: markerHtml,
                className: "custom-marker-wrapper",
                iconSize: [36, 36],
                iconAnchor: [18, 18],
              }),
            }).addTo(this.map);

            marker.bindPopup(`

              <div style="color: #333; font-family: Inter, sans-serif;">
                  <strong style="color: ${color};">${alert.type.toUpperCase()} ALERT</strong><br>
                  <strong>Location:</strong> ${alert.location}<br>
                  <strong>Time:</strong> ${alert.timestamp.toLocaleTimeString()}<br>
                  <hr style="margin: 8px 0;">
                  <em>"${alert.text}"</em>
              </div>
            `);

            this.markers.push({ marker, alert });

            // Set view on marker with a FIXED zoom level for consistency
            console.log("Setting map view to:", validCoordinates);

            // Use setView instead of flyTo for more reliable placement
            this.map.setView(validCoordinates, 11);

            // Add a visual indicator for debugging (will show where the center is)
            const centerMarker = L.circleMarker(validCoordinates, {
              radius: 5,
              color: "white",
              fillColor: "#f03",
              fillOpacity: 0.5,
              weight: 1,
            }).addTo(this.map);

            // Remove the center indicator after 3 seconds
            setTimeout(() => {
              this.map.removeLayer(centerMarker);
            }, 3000);

            console.log(
              "%cMarker added successfully",
              "background: green; color: white; padding: 3px;"
            );
          } catch (markerError) {
            console.error("Error creating marker:", markerError);
          }
        }

        getAlertColor(type) {
          const colors = {
            fire: "linear-gradient(135deg, #ff6b6b, #ee5a24)",
            flood: "linear-gradient(135deg, #45b7d1, #2980b9)",
            earthquake: "linear-gradient(135deg, #f39c12, #e67e22)",
            landslide: "linear-gradient(135deg, #8b4513, #a0522d)",
            unknown: "linear-gradient(135deg, #95a5a6, #7f8c8d)",
          };
          return colors[type] || colors.unknown;
        }

        updateAlertsDisplay() {
          const alertsList = document.getElementById("alertsList");

          // Add this check to prevent the error
          if (!alertsList) {
            console.log("Alerts list element not found - skipping update");
            return;
          }

          const filteredAlerts = this.alerts.filter(
            (alert) =>
              (this.activeFilter === "all" ||
                alert.type === this.activeFilter) &&
              (this.activeStatusFilter === "all" ||
                (alert.status || "pending") === this.activeStatusFilter)
          );

          const username = "anonymous"; // Replace localStorage.getItem("username");
          alertsList.innerHTML = filteredAlerts
            .map(
              (alert, idx) => `
      <div class="alert-item">
        <div class="alert-icon ${alert.type}">
          ${alert.icon}
        </div>
        <div class="alert-info">
          <div class="alert-type">${alert.type} Alert</div>
          <div class="alert-location">${alert.location}</div>
          <div class="alert-time">${alert.timestamp.toLocaleTimeString()}</div>
          <span class="status-badge status-${alert.status || "pending"}">${(
                alert.status || "pending"
              ).toUpperCase()}</span>
          ${
            false // Replace username === "admin" condition
              ? `<button class="status-btn" data-idx="${idx}">Change Status</button>`
              : ""
          }
        </div>
      </div>
    `
            )
            .join("");

          document.querySelectorAll(".status-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              const idx = btn.dataset.idx;
              const alert = filteredAlerts[idx];
              const nextStatus = getNextStatus(alert.status || "pending");
              // Update status in backend
              try {
                await fetch(`${API_BASE}/alerts/${alert.id}`, {
                  method: "PATCH",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ status: nextStatus }),
                });
                alert.status = nextStatus;
                btn.previousElementSibling.textContent =
                  nextStatus.toUpperCase();
                btn.previousElementSibling.className = `status-badge status-${nextStatus}`;
                this.loadAlertsFromBackend(); // Refresh alerts
              } catch (err) {
                alert("Failed to update status.");
              }
            });
          });

          // Helper function
          function getNextStatus(current) {
            if (current === "pending") return "verified";
            if (current === "verified") return "resolved";
            return "pending";
          }
        }

        updateMapMarkers() {
          // Clear existing markers
          this.markers.forEach(({ marker }) => {
            this.map.removeLayer(marker);
          });
          this.markers = [];

          // Add filtered markers
          const filteredAlerts =
            this.activeFilter === "all"
              ? this.alerts
              : this.alerts.filter((alert) => alert.type === this.activeFilter);

          const statusFilteredAlerts =
            this.activeStatus === "all"
              ? filteredAlerts
              : filteredAlerts.filter(
                  (alert) => alert.status === this.activeStatus
                );

          statusFilteredAlerts.forEach((alert) => {
            this.addMapMarkerOnly(alert);
          });
        }

        addMapMarkerOnly(alert) {
          // Skip if coordinates are invalid
          if (
            !alert.coordinates ||
            !Array.isArray(alert.coordinates) ||
            alert.coordinates.length !== 2
          ) {
            console.warn(
              "Skipping marker - invalid coordinates:",
              alert.coordinates
            );
            return;
          }

          const color = this.getAlertColor(alert.type);

          const markerHtml = `
            <div class="custom-marker" style="background: ${color};">
              ${alert.icon}
            </div>
          `;

          const marker = L.marker(alert.coordinates, {
            icon: L.divIcon({
              html: markerHtml,
              className: "custom-marker-wrapper",
              iconSize: [36, 36],
              iconAnchor: [18, 18],
            }),
          }).addTo(this.map);

          marker.bindPopup(`
            <div style="color: #333; font-family: Inter, sans-serif;">
              <strong style="color: ${color};">${alert.type.toUpperCase()} ALERT</strong><br>
              <strong>Location:</strong> ${alert.location}<br>
              <strong>Time:</strong> ${alert.timestamp.toLocaleTimeString()}<br>
              <hr style="margin: 8px 0;">
              <em>"${alert.text}"</em>
            </div>
          `);

          this.markers.push({ marker, alert });
        }

        updateStats() {
          // Since you've removed the stats display elements, we'll keep this as a minimal implementation
          console.log("Stats update skipped - no stats elements in DOM");

          // If you want to see alert statistics in console:
          const stats = {
            total: this.alerts.length,
            byType: {
              accident: this.alerts.filter((a) => a.type === "accident").length,
              fire: this.alerts.filter((a) => a.type === "fire").length,
              flood: this.alerts.filter((a) => a.type === "flood").length,
              medical: this.alerts.filter((a) => a.type === "medical").length,
              other: this.alerts.filter((a) => a.type === "other").length,
            },
            byStatus: {
              medical: this.alerts.filter((a) => a.type === "medical").length,
              other: this.alerts.filter((a) => a.type === "other").length,
            },
            byStatus: {
              pending: this.alerts.filter(
                (a) => a.status === "pending" || !a.status
              ).length,
              verified: this.alerts.filter((a) => a.status === "verified")
                .length,
              resolved: this.alerts.filter((a) => a.status === "resolved")
                .length,
            },
          };

          // For debugging purposes
          // console.table(stats);
        }

        showSuccessMessage(message) {
          // Create a temporary floating message instead of using status indicator
          const successMessage = document.createElement("div");
          successMessage.innerHTML = `<i class="fas fa-check"></i> ${message}`;
          successMessage.style.position = "fixed";
          successMessage.style.bottom = "20px";
          successMessage.style.left = "50%";
          successMessage.style.transform = "translateX(-50%)";
          successMessage.style.background = "rgba(76, 175, 80, 0.9)";
          successMessage.style.color = "white";
          successMessage.style.padding = "10px 20px";
          successMessage.style.borderRadius = "20px";
          successMessage.style.zIndex = "2000";

          document.body.appendChild(successMessage);

          setTimeout(() => {
            document.body.removeChild(successMessage);
          }, 3000);
        }

        async loadAlertsFromBackend() {
          this.alerts = [];
          this.updateMapMarkers();

          try {
            const res = await fetch(`${API_BASE}/alerts`);
            const data = await res.json();
            data.forEach((alert) => {
              alert.timestamp = new Date(alert.timestamp);
              this.alerts.push(alert);
              this.addMapMarkerOnly(alert);
            });
            this.updateStats();
            this.updateChart();
            // Remove these lines:
            // document.querySelector(".status-indicator").innerHTML =
            //   '<i class="fas fa-satellite-dish"></i> System Online';
            // document.querySelector(".status-indicator").style.background =
            //   "rgba(76, 175, 80, 0.9)";
          } catch (e) {
            // Remove these lines:
            // document.querySelector(".status-indicator").innerHTML =
            //   '<i class="fas fa-times-circle"></i> Backend Offline';
            // document.querySelector(".status-indicator").style.background =
            //   "rgba(244, 67, 54, 0.9)";
            this.updateStats();
          }
        }

        async checkLocationStatus() {
          const locationInput = document
            .getElementById("locationInput")
            .value.trim();
          if (!locationInput) return;

          const locationStatusDiv = document.getElementById("locationStatus");
          locationStatusDiv.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Checking...';

          try {
            const res = await fetch(`${API_BASE}/check-location`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ location: locationInput }),
              credentials: "include",
            });
            const data = await res.json();
            if (res.ok) {
              locationStatusDiv.innerHTML = `
                <div style="color: #4caf50;">
                  <i class="fas fa-check-circle"></i> ${data.message}
                </div>
              `;
            } else {
              locationStatusDiv.innerHTML = `
                <div style="color: #f44336;">
                  <i class="fas fa-times-circle"></i> ${data.error}
                </div>
              `;
            }
          } catch (e) {
            locationStatusDiv.innerHTML = `
              <div style="color: #f44336;">
                <i class="fas fa-times-circle"></i> Network error
              </div>
            `;
          }
        }

        updateChart() {
          // Since you don't have a chart implementation but you're calling this method
          // Add an empty implementation to prevent errors
          // This matches the commented out canvas element: <!-- <canvas id="alertsChart"></canvas> -->
          console.log("Chart update skipped - no chart implementation");
        }

        // Qloo API Integration
        async callQlooAPI(preferences) {
          try {
            const API_KEY = "qB3n1WqHnslFJU5AQ5PKxjFsU_Pt_ecAdbcPz773o6c";

            // Format the preferences for Qloo API
            const qlooPayload = {
              consumer: {
                id: "user-" + Date.now(),
                taste_profile: {
                  "media.cuisine": preferences.cuisine || "",
                  "media.music": preferences.music || "",
                  "activity.general": preferences.activities || "",
                  "metadata.region": preferences.region || "",
                },
              },
              n_results: 5,
              target_verticals: [
                "media.location",
                "retail.product",
                "media.cuisine",
              ],
              use_case: "emergency_recommendations",
            };

            // Call the Qloo API (using a CORS proxy if needed)
            const response = await fetch(
              "https://cors-anywhere.herokuapp.com/https://api.qloo.com/v1/recommendations",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${API_KEY}`,
                },
                body: JSON.stringify(qlooPayload),
              }
            );

            return await response.json();
          } catch (error) {
            console.error("Qloo API Error:", error);
            return { error: "Failed to get cultural recommendations" };
          }
        }

        // Enhanced AI Assistant with Cultural Context
        async generateCulturalSafetyResponse(
          userQuery,
          location,
          disasterType
        ) {
          // Get user preferences from localStorage
          const preferences = JSON.parse(
            localStorage.getItem("userPreferences") || "{}"
          );

          // Call Qloo API to get cultural recommendations if we have preferences
          let culturalContext = {};
          if (Object.keys(preferences).length > 0) {
            const qlooResults = await this.callQlooAPI(preferences);
            culturalContext = qlooResults;
          }

          // Prepare context for the LLM

          let promptContext = `
User Query: ${userQuery}
Location: ${location || "Unknown"}
Disaster Type: ${disasterType || "Unknown"}
               
User Cultural Preferences: ${JSON.stringify(preferences)}
Qloo Cultural Recommendations: ${JSON.stringify(culturalContext)}

Based on the user's cultural preferences and the Qloo recommendations, provide a personalized safety response that is culturally relevant. Include:
1. Basic safety information for the disaster type
2. Cultural considerations specific to the user's preferences
3. Recommended safe locations that align with user's taste profile
4. Cultural-specific emergency supplies if relevant

Format your response to be concise but culturally sensitive.
`;

          try {
            // We'll use our existing chatbot backend but pass the enhanced context
            const response = await fetch(`${API_BASE}/chatbot`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                message: promptContext,
                enhancedMode: true,
              }),
            });

            const data = await response.json();

            // Format the response to highlight different sections
            let formattedResponse = data.response || "No response from model.";

            // Apply special formatting
            formattedResponse = formattedResponse
              .replace(
                "Cultural Consideration:",
                "<span style='color: #ffa726; font-weight: bold;'>Cultural Consideration:</span>"
              )
              .replace(
                "Safe Locations:",
                "<span style='color: #4caf50; font-weight: bold;'>Safe Locations:</span>"
              )
              .replace(
                "Based on your preferences:",
                "<span style='color: #ff6b6b; font-weight: bold;'>Based on your preferences:</span>"
              );

            // Update the display with the formatted response
            aiReplyDiv.innerHTML = `
              <div style="margin-bottom: 10px;">
                <span style="font-weight: bold; color: #4ecdc4;">You asked:</span>
                <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 4px;">
                  ${userInput}
                </div>
              </div>
              <div style="margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span style="font-weight: bold; color: #4ecdc4;">CulturalSafe‚Ñ¢ Response:</span>
                  <span style="font-size: 0.7rem; background: rgba(76, 205, 196, 0.2); padding: 2px 8px; border-radius: 10px;">
                    Powered by Qloo's Taste AI‚Ñ¢
                  </span>
                </div>
                <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 4px; white-space: pre-line;">
                  ${formattedResponse}

                </div>
                           </div>
            `;
          } catch (e) {
            console.error(e);
            aiReplyDiv.innerHTML = `
              <div style="margin-bottom: 10px;">
                <span style="font-weight: bold; color: #4ecdc4;">You asked:</span>
                <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 4px;">
                  ${userInput}
                </div>
              </div>
              <div style="margin-top: 10px;">
                <span style="font-weight: bold; color: #4ecdc4;">CulturalSafe‚Ñ¢ Response:</span>
                <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 4px; color: #ff6b6b;">
                  <i class="fas fa-exclamation-triangle"></i> Connection error. Please ensure the backend systems are running.
                </div>
              </div>
            `;
          }
        }
      }

      const app = new RescueEyeApp();

      // AI Assistance button (Get AI Recommendations)
      const aiAssistBtn = document.getElementById("aiAssistBtn");
      if (aiAssistBtn) {
        aiAssistBtn.onclick = async () => {
          // Function content here
        };
      }

      // Extract location from user query
      function extractLocationFromQuery(query) {
        // Check for direct location questions
        const locationPatterns = [
          /(?:in|at|for|about|around|near)\s+([A-Za-z\s,]+)(?:\?|$)/i,
          /(?:weather|conditions|disasters?|flood(?:s|ing)?|earthquake(?:s)?|fire(?:s)?|hurricane(?:s)?|storm(?:s)?|tsunami(?:s)?|tornado(?:es)?)\s+(?:in|at|for|of|near)\s+([A-Za-z\s,]+)(?:\?|$)/i,
          /(?:is\s+there(?:\s+a)?\s+(?:disaster|flood(?:ing)?|earthquake|fire|hurricane|storm|tsunami|tornado))\s+in\s+([A-Za-z\s,]+)(?:\?|$)/i,
          /([A-Za-z\s,]+?)(?:\s+weather|disaster|flood|earthquake|fire)(?:\?|$)/i,
        ];

        for (const pattern of locationPatterns) {
          const match = query.match(pattern);
          if (match && match[1]) {
            return match[1].trim();
          }
        }

        // Check if query is just a location name
        if (/^[A-Za-z\s,]+$/.test(query)) {
          return query.trim();
        }

        return null;
      }

      // Fetch weather data for a location
      async function fetchWeatherData(location) {
        try {
          // Get current weather
          const weatherRes = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(
              location
            )}&appid=21af7453a5b5eea1f18565bb32fb31af&units=metric`
          );
          const currentWeather = await weatherRes.json();

          // Get weather forecast (next 5 days)
          const forecastRes = await fetch(
            `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(
              location
            )}&appid=21af7453a5b5eea1f18565bb32fb31af&units=metric&cnt=8`
          );
          const forecast = await forecastRes.json();

          return {
            current: currentWeather,
            forecast: forecast,
          };
        } catch (e) {
          console.error("Weather API error:", e);
          return null;
        }
      }

      // Fetch disaster data for a location
      async function fetchDisasterData(location) {
        try {
          const res = await fetch(
            `${API_BASE}/disaster?location=${encodeURIComponent(location)}`
          );
          return await res.json();
        } catch (e) {
          console.error("Disaster API error:", e);
          return { status: "Error fetching disaster data." };
        }
      }

      // Display general response when no location is found
      function displayGeneralResponse(aiReplyDiv, userInput) {
        const generalResponses = [
          "I'm your RescueEye AI Assistant. You can ask me about weather conditions and disaster situations in specific locations. For example, try asking 'Is there flooding in New York?' or 'Weather in Tokyo'.",
          "Hello! I can provide information about current weather and disaster alerts for specific locations. Just mention a city or region in your question.",
        ];
        aiReplyDiv.innerHTML = `
          <div style="margin-bottom: 10px;">
            <span style="font-weight: bold; color: #4ecdc4;">You asked:</span>
            <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 4px;">
              ${userInput}
            </div>
          </div>
          <div style="margin-top: 10px;">
            <span style="font-weight: bold; color: #4ecdc4;">AI Response:</span>
            <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 4px; white-space: pre-line;">
              ${
                generalResponses[
                  Math.floor(Math.random() * generalResponses.length)
                ]
              }
            </div>
          </div>
        `;
      }

      // Generate safety advice based on disaster type
      function getSafetyAdvice(disasterType) {
        const adviceMap = {
          flood: `
üö® FLOOD SAFETY ADVICE:
‚Ä¢ Move to higher ground immediately
‚Ä¢ Do NOT walk, swim, or drive through flood waters
‚Ä¢ Stay off bridges over fast-moving water
‚Ä¢ Evacuate if told to do so by authorities
‚Ä¢ Monitor emergency radio and alerts
‚Ä¢ Prepare for evacuation (take only essentials)
‚Ä¢ Avoid contact with flood water (may be contaminated)`,

          earthquake: `
üö® EARTHQUAKE SAFETY ADVICE:
‚Ä¢ DROP to the ground
‚Ä¢ COVER by getting under a sturdy table
‚Ä¢ HOLD ON until shaking stops
‚Ä¢ Stay away from windows and exterior walls
‚Ä¢ If outdoors, move to a clear area away from buildings
‚Ä¢ If in a vehicle, pull over away from buildings and power lines
‚Ä¢ Be prepared for aftershocks
‚Ä¢ Check for injuries and damage after shaking stops`,

          fire: `
üö® FIRE SAFETY ADVICE:
‚Ä¢ Evacuate immediately if authorities advise
‚Ä¢ Close all doors behind you when evacuating
‚Ä¢ If caught in smoke, get low and crawl under the smoke
‚Ä¢ Feel doors before opening - if hot, find another escape route
‚Ä¢ Designate a meeting place outside
‚Ä¢ Call emergency services once safely outside
‚Ä¢ Never go back inside a burning building
‚Ä¢ If trapped, cover vents and call for help`,

          hurricane: `
üö® HURRICANE SAFETY ADVICE:
‚Ä¢ Evacuate if directed by authorities
‚Ä¢ Stay informed via emergency broadcasts
‚Ä¢ Secure your home - board windows and secure outdoor objects
‚Ä¢ Have emergency supplies ready
‚Ä¢ Fill bathtubs and containers with water
‚Ä¢ Stay away from windows during the storm
‚Ä¢ Be aware of flooding and storm surges
‚Ä¢ Do not walk, swim or drive through flood waters`,

          tornado: `
üö® TORNADO SAFETY ADVICE:
‚Ä¢ Seek shelter immediately in a basement or interior room
‚Ä¢ Stay away from windows and doors
‚Ä¢ Cover yourself with a heavy blanket or mattress
‚Ä¢ Keep your phone charged and have backup power sources
‚Ä¢ Document any property damage with photos`,
        };
      }

      // Replace the current generateAIResponse function with this enhanced version
      function generateAIResponse(query, location, weatherData, disasterData) {
        let response = "";

        // Enhanced weather information
        if (weatherData && weatherData.current && weatherData.current.main) {
          const current = weatherData.current;
          const forecast = weatherData.forecast;

          response += `üìç ${current.name}, ${current.sys.country}\n\n`;

          // Current weather details - expanded
          response += `üå°Ô∏è **Current Weather**\n`;
          response += `‚Ä¢ Temperature: ${current.main.temp}¬∞C (feels like ${current.main.feels_like}¬∞C)\n`;
          response += `‚Ä¢ Conditions: ${current.weather[0].description}\n`;
          response += `‚Ä¢ Humidity: ${current.main.humidity}%\n`;
          response += `‚Ä¢ Wind: ${current.wind.speed} m/s`;
          if (current.wind.deg) {
            response += ` from ${getWindDirection(current.wind.deg)}\n`;
          } else {
            response += `\n`;
          }

          // Add pressure, visibility, cloudiness
          response += `‚Ä¢ Pressure: ${current.main.pressure} hPa\n`;
          response += `‚Ä¢ Visibility: ${(current.visibility / 1000).toFixed(
            1
          )} km\n`;
          response += `‚Ä¢ Cloudiness: ${current.clouds.all}%\n`;

          // Add sunrise and sunset times
          if (current.sys && current.sys.sunrise && current.sys.sunset) {
            const sunriseTime = new Date(
              current.sys.sunrise * 1000
            ).toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });
            const sunsetTime = new Date(
              current.sys.sunset * 1000
            ).toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });
            response += `‚Ä¢ Sunrise: ${sunriseTime}\n`;
            response += `‚Ä¢ Sunset: ${sunsetTime}\n`;
          }

          // Add forecast information
          if (forecast && forecast.list && forecast.list.length > 0) {
            response += `\nüîÆ **Weather Forecast**\n`;

            // Show next 3 periods (usually 3-hour intervals)
            for (let i = 0; i < Math.min(3, forecast.list.length); i++) {
              const period = forecast.list[i];
              const time = new Date(period.dt * 1000).toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              });
              const date = new Date(period.dt * 1000).toLocaleDateString([], {
                weekday: "short",
                month: "short",
                day: "numeric",
              });

              response += `‚Ä¢ ${date} at ${time}: ${period.main.temp}¬∞C, ${period.weather[0].description}\n`;
            }
          }

          // Add weather advice based on conditions
          response += `\nüß† **Weather Insights**\n`;
          response += getWeatherAdvice(current, query) + "\n";
        } else {
          response += `I couldn't find weather information for "${location}".\n\n`;
        }

        // Disaster information (keep your existing code)
        const hasDisaster =
          disasterData &&
          disasterData.status &&
          disasterData.status !== "No disaster reported. Area is normal.";

        if (hasDisaster) {
          response += `\n‚ö†Ô∏è **ALERT**: ${disasterData.status}\n\n`;

          // Determine disaster type for safety advice
          let disasterType = "general";
          const disasterStatus = disasterData.status.toLowerCase();

          if (disasterStatus.includes("flood")) disasterType = "flood";
          else if (disasterStatus.includes("earthquake"))
            disasterType = "earthquake";
          else if (disasterStatus.includes("fire")) disasterType = "fire";
          else if (
            disasterStatus.includes("hurricane") ||
            disasterStatus.includes("cyclone")
          )
            disasterType = "hurricane";
          else if (disasterStatus.includes("tornado")) disasterType = "tornado";
          else if (disasterStatus.includes("tsunami")) disasterType = "tsunami";

          response += getSafetyAdvice(disasterType);

          // Add emergency contact reminder
          response += `\n\nPlease contact local emergency services if you're in danger.`;
        } else if (disasterData && disasterData.status) {
          response += `\n‚úÖ **SAFETY STATUS**: No disasters currently reported in ${location}.\n`;
          response += `The area appears to be safe based on current data. However, always stay informed about changing conditions.\n`;
        } else {
          response += `\nI couldn't retrieve disaster information for ${location} at this time.\n`;
          response += `Please check official local sources for the most current emergency information.`;
        }

        return response;
      }

      // Add these new helper functions
      function getWindDirection(degrees) {
        const directions = [
          "North",
          "Northeast",
          "East",
          "Southeast",
          "South",
          "Southwest",
          "West",
          "Northwest",
        ];
        return directions[Math.round(degrees / 45) % 8];
      }

      function getWeatherAdvice(weatherData, query) {
        let advice = "";
        const temp = weatherData.main.temp;
        const conditions = weatherData.weather[0].main.toLowerCase();
        const windSpeed = weatherData.wind.speed;

        // Temperature advice
        if (temp > 32) {
          advice +=
            "‚Ä¢ Extreme heat - stay hydrated, limit outdoor activities, seek air-conditioned spaces\n";
        } else if (temp > 27) {
          advice +=
            "‚Ä¢ Hot conditions - wear light clothing, use sunscreen, drink plenty of water\n";
        } else if (temp > 20) {
          advice += "‚Ä¢ Warm and pleasant - good for outdoor activities\n";
        } else if (temp > 10) {
          advice +=
            "‚Ä¢ Mild temperatures - consider a light jacket or sweater\n";
        } else if (temp > 0) {
          advice += "‚Ä¢ Cool weather - wear layers and a jacket\n";
        } else if (temp > -10) {
          advice +=
            "‚Ä¢ Cold conditions - dress warmly with proper winter clothing\n";
        } else {
          advice +=
            "‚Ä¢ Extreme cold - limit time outdoors, wear appropriate winter gear\n";
        }

        // Weather condition advice
        if (conditions.includes("rain") || conditions.includes("drizzle")) {
          advice += "‚Ä¢ Rainy conditions - bring an umbrella or raincoat\n";
          if (conditions.includes("thunder")) {
            advice +=
              "‚Ä¢ Thunderstorm alert - seek shelter indoors, avoid open spaces and tall objects\n";
          }
        } else if (conditions.includes("snow")) {
          advice +=
            "‚Ä¢ Snowy conditions - allow extra travel time, wear appropriate footwear\n";
        } else if (conditions.includes("fog")) {
          advice +=
            "‚Ä¢ Foggy conditions - reduced visibility, drive with caution\n";
        } else if (conditions.includes("clear")) {
          if (temp > 25) {
            advice += "‚Ä¢ Sunny day - wear sunscreen and stay hydrated\n";
          } else {
            advice += "‚Ä¢ Clear skies - excellent for outdoor activities\n";
          }
        } else if (conditions.includes("cloud")) {
          advice += "‚Ä¢ Cloudy conditions - consider bringing a light jacket\n";
        }

        // Wind advice
        if (windSpeed > 15) {
          advice +=
            "‚Ä¢ Strong winds - secure loose objects outdoors, be cautious with high-profile vehicles\n";
        } else if (windSpeed > 8) {
          advice +=
            "‚Ä¢ Moderately windy conditions - could affect outdoor activities\n";
        }

        // Travel advice based on query
        if (
          query.toLowerCase().includes("travel") ||
          query.toLowerCase().includes("trip") ||
          query.toLowerCase().includes("visit")
        ) {
          advice += "\n**Travel Recommendations**:\n";

          if (conditions.includes("clear") && temp > 15 && temp < 30) {
            advice += "‚Ä¢ Excellent weather for tourism and sightseeing\n";
          } else if (
            (conditions.includes("rain") && weatherData.rain) ||
            (conditions.includes("snow") && weatherData.snow)
          ) {
            advice += "‚Ä¢ Consider indoor activities due to precipitation\n";
          }

          if (temp > 30) {
            advice +=
              "‚Ä¢ Plan indoor activities during peak heat hours (10am-4pm)\n";
          } else if (temp < 5) {
            advice +=
              "‚Ä¢ Dress warmly and plan for shorter outdoor excursions\n";
          }
        }

        return advice;
      }
    </script>
  </body>
</html>
